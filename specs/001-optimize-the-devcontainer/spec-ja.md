# 機能仕様書: DevContainer漸進的最適化

> **注意**: これは参照用の日本語版です。正式な仕様書は英語版 (`spec.md`) を参照してください。
> **Note**: This is a Japanese reference version. The official specification is the English version (`spec.md`).

**機能ブランチ**: `001-optimize-the-devcontainer`
**作成日**: 2025-09-13
**ステータス**: 改訂済み
**入力**: `~/WORK/.devcontainer/` にある既存の動作するDevContainer設定を、既存の全機能とマルチプロジェクトアーキテクチャを保持しながらパフォーマンス向上させる最適化。

**現在の状態**: DevContainer設定は完全に機能し、3台のマシンで実証済み。以下を正常にサポート:
- マルチプロジェクトワークスペース (`~/WORK/` → `/workspace/`)
- 適切なAPIキーマウントによるClaude Code統合
- 完全設定済みPowerlevel10kターミナル
- 40+パッケージのPythonデータサイエンススタック
- iptablesファイアウォール付きネットワーク機能
- 包括的開発ツール (git-delta, fzf, GitHub CLI)

**最適化目標**: 実証済みアーキテクチャを変更することなく、また既存機能にリスクを与えることなく、ビルドパフォーマンス、キャッシュ、保守性に対する漸進的改善を行う。

---

## ユーザーシナリオ＆テスト *(必須)*

### 主要ユーザーストーリー
現在動作しているDevContainerセットアップを複数のプロジェクトで使用する開発者として、Claude Code統合とマルチプロジェクトワークフローで完璧に動作する実証済みで安定した開発環境に対してリスクなく、小さなパフォーマンス向上とより良いキャッシュが必要です。

### 受け入れシナリオ
1. **前提条件** 現在動作するDevContainer設定に対して、**実行** 最適化が適用されるとき、**結果** コンテナは同一の機能とツール可用性を維持しながらより高速にビルドされなければならない

2. **前提条件** 既存のプロジェクトを持つマルチプロジェクトワークスペースで、**実行** 最適化されたコンテナを使用するとき、**結果** すべてのプロジェクトはClaude Code統合の回帰なくアクセス可能で機能的でなければならない

3. **前提条件** 開発中のパッケージインストール（npm、pip）で、**実行** キャッシュ最適化を使用するとき、**結果** 後続のインストールは既存のすべてのパッケージとバージョンを保持しながら高速化されるべき

4. **前提条件** 現在のPowerlevel10kターミナルとすべてのシェル設定に対して、**実行** 最適化が適用されるとき、**結果** ターミナル体験は視覚的または機能的変更なく同一でなければならない

5. **前提条件** 現在のファイアウォール初期化とネットワーク機能で、**実行** コンテナが開始するとき、**結果** すべてのセキュリティ設定とiptablesルールは以前と同様に動作しなければならない

6. **前提条件** ワークスペース内の新しいプロジェクトディレクトリで、**実行** 開発者がSpecKit初期化スクリプトを実行するとき、**結果** プロジェクトは適切なディレクトリ構造とAI支援開発ワークフローテンプレートでセットアップされるべき

7. **前提条件** 新しいWSL2環境で、**実行** 開発者がGitHubからDevContainer設定をクローンしてVS Codeで開くとき、**結果** 最小限の手動設定で完全に機能する開発環境が作成されるべき

8. **前提条件** MCPサーバー統合が必要な開発プロジェクトで、**実行** 開発者がSerena MCP初期化スクリプトを実行するとき、**結果** プロジェクトは適切なMCPサーバーセットアップと接続テンプレートで設定されるべき

### エッジケース
- キャッシュディレクトリがまだ存在しない場合、コンテナは正常にビルドされなければならない
- 機能が破綻した場合、最適化のロールバックは即座でなければならない
- 既存のマウントされたボリュームと設定はすべて互換性を保たなければならない
- ビルドプロセスはホストマシンセットアップの変更を要求してはならない

## 要件 *(必須)*

### 機能要件
- **FR-001**: システムは現在の正確なマルチプロジェクトワークスペースアーキテクチャ (`~/WORK/` → `/workspace/`) を保持しなければならない
- **FR-002**: システムは現在のすべてのClaude Codeマウントと統合 (`~/.claude`, `~/.claude.json`) を維持しなければならない
- **FR-003**: システムは現在のファイアウォール機能 (NET_ADMIN, NET_RAW, init-firewall.sh) を保持しなければならない
- **FR-004**: システムは同一のPowerlevel10kターミナル設定と外観を維持しなければならない
- **FR-005**: システムは現在のすべてのPythonパッケージとバージョン（データサイエンススタックを含む40+パッケージ）を保持しなければならない
- **FR-006**: システムは現在のnodeユーザーの権限とsudo設定を維持しなければならない
- **FR-007**: システムは現在のシェルプラグインとzsh設定を保持しなければならない
- **FR-008**: システムは現在の開発ツール (git-delta, fzf, GitHub CLI, aggregate) を維持しなければならない
- **FR-009**: システムはパッケージ選択を変更せずにレイヤー最適化を通じてDockerビルドパフォーマンスを向上させなければならない
- **FR-010**: システムは既存機能に影響を与えずにパッケージマネージャキャッシュ (npm, pip) を追加しなければならない
- **FR-011**: システムはランタイム動作に影響を与えずにビルドコンテキスト最適化を追加しなければならない
- **FR-012**: システムは最適化が問題を引き起こす場合の即座のロールバック機能を提供しなければならない
- **FR-013**: システムは現在のpostStartCommand動作とタイミングを維持しなければならない
- **FR-014**: システムは便利なAI支援開発ワークフローセットアップのためのSpecKitプロジェクト初期化スクリプトを含まなければならない
- **FR-015**: システムは最小限のセットアップ手順でGitHubクローンによる迅速なWSL2 DevContainer環境作成を可能にしなければならない
- **FR-016**: システムは便利なMCPサーバー管理と設定のためのSerena MCP初期化スクリプトを含まなければならない

### パフォーマンス要件
- **PR-001**: Dockerビルド時間はレイヤー統合により10-20%向上すべき
- **PR-002**: パッケージインストールは永続キャッシュにより15-30%向上すべき
- **PR-003**: ビルドコンテキスト転送は機能に影響を与えずに.dockerignoreにより削減されるべき
- **PR-004**: コンテナ起動時間は現在のベースラインから劣化してはならない

### 制約
- **C-001**: 基本アーキテクチャまたはマウントポイントの変更なし
- **C-002**: 既存パッケージまたはツールの削除/変更なし
- **C-003**: ユーザー体験またはターミナル外観の変更なし
- **C-004**: Claude Code統合または設定マウントの変更なし
- **C-005**: すべての変更は漸進的にテスト可能で即座に可逆でなければならない

### 主要エンティティ *(データが関与する場合に含める)*
- **現在の動作する設定**: Dockerfile (183行)、devcontainer.json、.p10k.zsh、init-firewall.shを持つ `/workspace/.devcontainer/` の実証済みDevContainerセットアップ
- **マルチプロジェクトワークスペース**: 同時にアクセス可能な複数のプロジェクトディレクトリを含む `/workspace/`
- **Claude統合**: 正確に保持されなければならない `~/.claude` と `~/.claude.json` の既存マウント
- **キャッシュディレクトリ**: 機能に影響を与えずにパフォーマンスを向上させるnpmとpipの新しいキャッシュマウント
- **レイヤー最適化**: インストールされるパッケージを変更せずに、より良いキャッシュのために再編成されたDockerfileレイヤー
- **SpecKit統合**: 適切なディレクトリ構造とテンプレートでAI支援開発ワークフローをセットアップするプロジェクト初期化スクリプト
- **GitHub配布**: 最小限のセットアップ要件で新しいWSL2環境でのクローンと即座の使用に対応した設定
- **Serena MCP統合**: 開発プロジェクトでのMCPサーバー管理と設定セットアップのための初期化スクリプト

---

## 最適化アプローチ

### フェーズ1: 測定とバックアップ
- 現在動作する設定のベースラインパフォーマンス指標を確立
- 現在動作する設定の完全バックアップを作成
- 回帰テストのために正確な現在の機能を文書化

### フェーズ2: 低リスク最適化
- ビルドコンテキストを削減する.dockerignoreを追加（ランタイム影響なし）
- Dockerfileのapt-get updateコールを統合（同じパッケージ、より良いレイヤー）
- 完全な機能検証で各変更を即座にテスト

### フェーズ3: キャッシュ実装
- npmとpipの永続キャッシュディレクトリを追加
- devcontainer.jsonにキャッシュマウントを追加
- キャッシュ効率とマルチプロジェクト互換性を検証

### フェーズ4: SpecKit統合
- SpecKitプロジェクト初期化スクリプトを追加
- AI支援開発用のプロジェクトテンプレートを作成
- Claude CodeとのSpecKitワークフロー統合をテスト

### フェーズ5: Serena MCP統合
- Serena MCP初期化スクリプトを追加
- MCPサーバー設定テンプレートを作成
- MCPサーバーセットアップと接続ワークフローをテスト

### フェーズ6: GitHub配布準備
- 包括的なセットアップドキュメントを作成
- 新しいWSL2環境向けのクイックスタートガイドを追加
- GitHubクローンと即座のセットアップワークフローをテスト

### フェーズ7: 検証とロールバック準備
- ベースラインとのパフォーマンス比較
- 現在のすべての機能の完全回帰テスト
- ロールバック手順を文書化してテスト

---

## レビュー＆受け入れチェックリスト

### コンテンツ品質
- [x] 既存の動作する設定の最適化に焦点を当てている
- [x] アーキテクチャ変更は提案されていない
- [x] 現在のすべての機能の保持が優先されている
- [x] リスク軽減とロールバック手順が定義されている

### 要件の完全性
- [x] 現在の機能保持要件がすべて指定されている
- [x] パフォーマンス向上目標は現実的（10-30%）
- [x] 制約がリスクの高い変更を明確に防いでいる
- [x] 成功基準は測定可能で保守的
- [x] テストアプローチが回帰防止を重視している

---

## 実行ステータス

- [x] 現在動作する設定が分析された
- [x] 保守的最適化アプローチが定義された
- [x] 保持要件が文書化された
- [x] リスク軽減戦略が確立された
- [x] 漸進的テスト手法が指定された

---

**成功の定義**: 設定は現在動作するセットアップと機能的に同一でありながら、より高速にビルドされ、より良くキャッシュされる。既存機能を破綻させる最適化は即座に復元される。