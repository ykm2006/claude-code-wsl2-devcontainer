{
  "$schema": "https://raw.githubusercontent.com/devcontainers/spec/main/schemas/devContainer.schema.json",
  "name": "{{workspace.name}} - Optimized Multi-Project Environment",

  "build": {
    "dockerfile": "{{dockerfile.path}}",
    "context": "{{build.context}}",
    "args": {
      "BASE_IMAGE": "{{workspace.baseImage}}",
      "TZ": "${localEnv:TZ:UTC}",
      "USER_UID": "${localEnv:USER_UID:1000}",
      "USER_GID": "${localEnv:USER_GID:1000}",
      "NODE_VERSION": "{{dependencies.node.version}}",
      "PYTHON_VERSION": "{{dependencies.python.version}}"
    }
  },

  "runArgs": [
    "--cap-add=NET_ADMIN",
    "--cap-add=NET_RAW",
    "--platform={{machineProfile.platform}}"
    {{#each machineProfile.capabilities}}
    ,"--cap-add={{this}}"
    {{/each}}
  ],

  "mounts": [
    {{#each workspace.sharedMounts}}
    {
      "source": "{{source}}",
      "target": "{{target}}",
      "type": "{{type}}"
      {{#if consistency}},"consistency": "{{consistency}}"{{/if}}
      {{#if readonly}},"readonly": {{readonly}}{{/if}}
    }{{#unless @last}},{{/unless}}
    {{/each}}
    {{#if workspace.projects}}
    {{#each workspace.projects}}
    {{#each mounts}}
    ,{
      "source": "{{source}}",
      "target": "{{target}}",
      "type": "{{type}}"
      {{#if consistency}},"consistency": "{{consistency}}"{{/if}}
      {{#if readonly}},"readonly": {{readonly}}{{/if}}
    }
    {{/each}}
    {{/each}}
    {{/if}}
    {{#if developerProfile.personalMounts}}
    {{#each developerProfile.personalMounts}}
    ,{
      "source": "{{source}}",
      "target": "{{target}}",
      "type": "{{type}}"
      {{#if consistency}},"consistency": "{{consistency}}"{{/if}}
      {{#if readonly}},"readonly": {{readonly}}{{/if}}
    }
    {{/each}}
    {{/if}}
  ],

  "containerEnv": {
    "WORKSPACE_ROOT": "/workspace",
    "TZ": "${localEnv:TZ:UTC}",
    "NODE_OPTIONS": "--max-old-space-size=4096",
    {{#if developerProfile.claudeConfig}}
    "CLAUDE_CONFIG_DIR": "{{developerProfile.claudeConfig.configDir}}",
    "CLAUDE_WORKSPACE_ROOT": "/workspace",
    {{#each developerProfile.claudeConfig.workflowSettings}}
    "{{@key}}": "{{this}}",
    {{/each}}
    {{/if}}
    "DOCKER_BUILDKIT": "1",
    "COMPOSE_DOCKER_CLI_BUILD": "1"
    {{#each workspace.projects}}
    {{#each environment}}
    ,"{{@key}}": "{{this}}"
    {{/each}}
    {{/each}}
  },

  "customizations": {
    "vscode": {
      "extensions": [
        "anthropic.claude-code",
        "ms-vscode.vscode-json",
        "eamodio.gitlens",
        "davidanson.vscode-markdownlint"
        {{#each developerProfile.customExtensions}}
        ,"{{this}}"
        {{/each}}
      ],
      "settings": {
        "terminal.integrated.defaultProfile.linux": "zsh",
        "terminal.integrated.fontFamily": "'MesloLGS NF', 'Hack Nerd Font', 'DejaVu Sans Mono'",
        "terminal.integrated.fontSize": 14,
        "editor.formatOnSave": true,
        "editor.tabSize": 2,
        "files.trimTrailingWhitespace": true,
        "git.autofetch": true,
        "git.confirmSync": false,
        "workbench.startupEditor": "none"
        {{#if developerProfile.claudeConfig}}
        ,"claude-code.contextFiles": [
          {{#each developerProfile.claudeConfig.contextFiles}}
          "{{this}}"{{#unless @last}},{{/unless}}
          {{/each}}
        ]
        {{/if}}
        {{#each developerProfile.preferences}}
        ,"{{@key}}": "{{this}}"
        {{/each}}
      }
    }
  },

  "features": {
    {{#each workspace.projects}}
    {{#each features}}
    "{{this}}": "latest"{{#unless @last}},{{/unless}}
    {{/each}}
    {{/each}}
  },

  "workspaceMount": "source=${localWorkspaceFolder},target=/workspace,type=bind,consistency={{machineProfile.workspaceConsistency}}",
  "workspaceFolder": "/workspace",

  "remoteUser": "{{workspace.user}}",

  "initializeCommand": [
    "docker", "system", "prune", "-f", "--filter", "until=24h"
  ],

  "onCreateCommand": [
    "git", "config", "--global", "init.defaultBranch", "main",
    "git", "config", "--global", "pull.rebase", "false",
    "mkdir", "-p", "/workspace/.devcontainer/cache"
  ],

  "postCreateCommand": [
    {{#if developerProfile.claudeConfig}}
    "echo", "'# Project Context for Claude' > CLAUDE.md",
    "mkdir", "-p", "{{developerProfile.claudeConfig.configDir}}/context",
    {{/if}}
    "sudo", "chown", "-R", "{{workspace.user}}:{{workspace.user}}", "/workspace"
  ],

  "postStartCommand": [
    {{#each workspace.postStartCommands}}
    "{{this}}"{{#unless @last}},{{/unless}}
    {{/each}}
  ],

  "waitFor": "postStartCommand",

  "shutdownAction": "stopCompose",

  "overrideCommand": false
}